<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"></script>
</head>
<style>
    * {
        outline: 0;
        margin: 0;
        padding: 0;
    }

    html {
        width: 100%;
        height: 100%;
    }

    body {
        width: 100%;
        height: 100%;
    }

    canvas {
        display: block;
        width: 100%;
        height: 100%;
        background-color: #eeeeee;
        position: absolute;
        left: 0;
        top: 0;
    }
    .dot {
        width: 10px;
        height: 10px;
        position: absolute;
        border-radius: 50%;
        background-color: red;
    }
    .dot1 {
        top: 50%;
        left: 10%;
    }
    .dot2 {
        top: 60%;
        right: 30%;
    }
    .dot3 {
        top: 20%;
        left: 40%;
    }
    #container {
        position: relative;
        width: 100%;
        height: 500px;
        margin: 50px;
        margin: 0 auto;
        background-color: transparent;
    }
    .card {
        border-radius: 5px;
        z-index: 5;
    }
</style>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <div class="dot dot1"></div>
        <div class="dot dot2"></div>
        <div class="dot dot3"></div>
    </div>

    <script>
        window.onload = () => {
            getPos();


            document.querySelectorAll(".card").forEach((item, idx) => {
                document.addEventListener("mousemove", function(e){
                    magnetize(item, e);
                });

                // item.addEventListener("mousemove", function(e){
                //     const { offsetLeft, offsetTop, offsetWidth, offsetHeight } = item.parentElement;
                //     const left = e.pageX - offsetLeft;
                //     const top = e.pageY - offsetTop;
                //     const centerX = left - offsetWidth / 2;
                //     const centerY = top - offsetHeight / 2;

                //     // item.style.transition = "";
                //     item.style.transform = `translate3d(${centerX / 4}px, ${centerY / 4}px, 0)`;
                // });

                // item.addEventListener("mouseleave", function(e){
                //     let target_idx = Number(item.parentElement.getAttribute("data-idx"));

                //     console.log(`idx: ${idx+1} | target_idx: ${target_idx}`);

                //     if((idx+1) === target_idx){
                //         console.log(transform)
                //         // item.style.transition = "all .3s ease-out"
                //         item.style.transform = transform;
                //     }
                // });
            });
        };

        function magnetize(el, e) {
            const mX = e.pageX,
                mY = e.pageY;
            const customDist = 100;
            const centerX = el.offsetLeft + (el.offsetWidth / 2);
            const centerY = el.offsetTop + (el.offsetHeight / 2);
            const deltaX = Math.floor((centerX - mX)) * -0.45;
            const deltaY = Math.floor((centerY - mY)) * -0.45;
            const distance = calculateDistance(el, mX, mY);

            console.log(el.offsetLeft)

            if(distance < customDist) gsap.to(el, 0.5, { y: deltaY, x: deltaX });
            else gsap.to(el, 0.6, { y: 0,x: 0 });
            
            drawLine({ stage: "init" });
        }

        function calculateDistance(elem, mouseX, mouseY) {

            return Math.floor(Math.sqrt(Math.pow(mouseX - (elem.offsetLeft + (elem.offsetWidth / 2)), 2) + Math.pow(
                mouseY - (elem.offsetTop + (elem.offsetHeight / 2)), 2)));
        }

        function getPos(){
            const dot = document.querySelectorAll(".dot");

            dot.forEach((item, idx) => {
                const data = item.getBoundingClientRect();
                const card = new Card({ data, target: item });
                card.createCard();

                item.setAttribute("data-idx", idx+1);
            });
            drawLine();
        }

        class Card {
            constructor(obj){
                this.dot_width = obj.data.width;
                this.dot_height = obj.data.height;
                this.target = obj.target;
                this.dot_data = this.target.getBoundingClientRect();
                this.corner_pos = [];
                this.centerX = Math.round((this.dot_data.width) / 2 + this.dot_data.x);
                this.centerY = Math.round((this.dot_data.height) / 2 + this.dot_data.y);
                this.cornerX = 0;
                this.cornerY = 0;
                this.canvas = document.getElementById("canvas");
                this.ctx = canvas.getContext("2d");
                this.stage_width = document.body.clientWidth;
                this.stage_height = document.body.clientHeight;
            }

            createCard(){
                const radius = 120;
                const PI2 = Math.PI * 2;
                const points = 30;
                const angle = PI2 / points;
                const width = 150;
                const height = 150;
                const random = Math.floor(Math.random() * points) + 1;
                let centerX, centerY, left, top;

                for(let i = 0; i < points; i++){
                    centerX = radius * Math.cos(angle * i);
                    centerY = radius * Math.sin(angle * i);
                    left = centerX + (this.dot_width / 2) - (width / 2) 
                    top = centerY + (this.dot_height / 2) - (height / 2) 

                    const card = document.createElement("div");
                    card.setAttribute("class", `card card-${i+1}`);
                    card.style.width = `${width}px`;
                    card.style.height = `${height}px`;
                    card.style.lineHeight = `${height}px`;
                    card.style.textAlign = "center";
                    card.style.backgroundColor = "yellow";
                    card.style.position = "absolute";
                    card.style.left = `${left}px`;
                    card.style.top = `${top}px`;
                    // card.style.transform = `translate3d(${left}px, ${top}px, 0)`;
                    card.style.fontSize = `18x`;
                    card.style.fontWeight = "bold";
                    card.style.outline = "1px solid red";
                    card.innerText = i + 1;

                    if(random === (i+1) && this.target.children.length === 0){
                        // console.log(`○○○○○○○○○○○○○○○○○○○○○○○○○○○ random: ${random} ○○○○○○○○○○○○○○○○○○○○○○○○○○○`);
                        this.target.appendChild(card);
                        this.checkCollision(card);
                    }
                }
                this.createCorner();
            }

            checkCollision(card_target){
                const container = document.getElementById("container");
                const cont_data = container.getBoundingClientRect();
                const dots = document.querySelectorAll(".dot");
                const target_data = card_target.getBoundingClientRect();
                const x1 = Math.round(target_data.x);
                const y1 =  Math.round(target_data.y);
                const x2 = x1 + target_data.width;
                const y2 = y1 + target_data.height;
                const stage_x1 = cont_data.x;
                const stage_y1 = cont_data.y;
                const stage_x2 = cont_data.x + cont_data.width;
                const stage_y2 = cont_data.y + cont_data.height;
                let x1_compare, y1_compare, x2_compare, y2_compare;

                dots.forEach((dot) => {
                    if(dot.children[0]){
                        const card = dot.children[0];
                        const card_data = card.getBoundingClientRect();
                        const parent_data = dot.getBoundingClientRect();
                        x1_compare =  Math.round(card_data.x);
                        y1_compare =  Math.round(card_data.y);
                        x2_compare = x1_compare + card_data.width;
                        y2_compare = y1_compare + card_data.height;

                        if(
                            (stage_x1 > x1_compare || stage_x2 < x2_compare) ||
                            (stage_y1 > y1_compare || stage_y2 < y2_compare)
                        ){
                            card.remove();
                            this.createCard({ data: parent_data , target: dot });
                        }

                        if(
                            (x1 < x1_compare && x1_compare < x2) && (y1 < y1_compare && y1_compare < y2) ||
                            (x1 < x1_compare && x1_compare < x2) && (y1 < y2_compare && y1_compare < y2) ||
                            (x1 < x2_compare && x2_compare < x2) && (y1 < y2_compare && y1_compare < y2) ||
                            (x1 < x2_compare && x2_compare < x2) && (y1 < y1_compare && y1_compare < y2)
                        ){
                            card_target.remove();
                            this.createCard({ data: parent_data , target: card_target.parentElem });
                        }
                    }
                });

                const corners = [
                    { width: this.centerX - x1_compare, height: this.centerY - y1_compare, x: x1_compare, y: y1_compare, pos: "left-top" },
                    { width: this.centerX - x1_compare, height: this.centerY - y2_compare, x: x1_compare, y: y2_compare, pos: "left-bottom" },
                    { width: this.centerX - x2_compare, height: this.centerY - y2_compare, x: x2_compare, y: y2_compare, pos: "right-bottom" },
                    { width: this.centerX - x2_compare, height: this.centerY - y1_compare, x: x2_compare, y: y1_compare, pos: "right-top" }
                ]
                this.corner_pos = corners;
            }

            createCorner(){
                const corner = document.createElement("div");

                this.corner_pos.forEach((item, idx) => {
                    const length = Math.round(Math.sqrt((item.width) * (item.width) + (item.height) * (item.height)));
                    this.corner_pos[idx].length = length;
                });
                this.corner_pos.sort(function(a, b) {
                    return a.length < b.length  ? -1 : a.length  > b.length  ? 1 : 0;
                });

                corner.classList.add("corner");
                // corner.style.width = "5px";
                // corner.style.height = "5px";
                corner.style.position = "absolute";
                corner.style.backgroundColor = "pink";

                if(this.corner_pos[0].pos === "left-top"){
                    corner.style.left = "2px";
                    corner.style.top = "2px";
                }
                if(this.corner_pos[0].pos === "right-top"){
                    corner.style.right = "2px";
                    corner.style.top = "2px";
                }
                if(this.corner_pos[0].pos === "left-bottom"){
                    corner.style.left = "2px";
                    corner.style.bottom = "2px";
                }
                if(this.corner_pos[0].pos === "right-bottom"){
                    corner.style.right = "2px";
                    corner.style.bottom = "2px";
                }

                if(this.target.children[0].children.length === 0) this.target.children[0].appendChild(corner);
            }
        }

        window.addEventListener("resize", function(e){
            resize();
            drawLine(); 
        });



        resize();
        function resize(){
            const canvas = document.getElementById("canvas");
            const container = document.getElementById("container");
            const px_ratio = window.pixelRatio = window.devicePixelRatio > 1 ? 2 : 1;
            let stage_width = container.clientWidth;
            let stage_height = container.clientHeight;

            canvas.width = stage_width;
            canvas.height = stage_height;
        }

        function drawLine(){
            const dots = document.querySelectorAll(".dot");
            const corners = document.querySelectorAll(".corner");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d"); 
            let pos = [];
            let obj;

            dots.forEach((item, idx) => {
                let data = item.getBoundingClientRect();
                let x = (data.width / 2) + data.x;
                let y = (data.height / 2) + data.y;

                obj = { centerX: x, centerY: y };
                pos.push(obj);
            });

            corners.forEach((item, idx) => {
                let data = item.getBoundingClientRect();
                let x = data.x;
                let y = data.y;

                pos[idx]["cornerX"] = x;
                pos[idx]["cornerY"] = y;
            });

            pos.forEach((item) => {
                ctx.beginPath();
                ctx.moveTo(item.centerX, item.centerY);
                ctx.lineTo(item.cornerX, item.cornerY);
                ctx.strokeStyle = '#ff0000';
                ctx.stroke();
            });
        }
    </script>
</body>
</html>
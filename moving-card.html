<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카드 테스트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"></script>
</head>
<style>
    * {
        outline: 0;
        margin: 0;
        padding: 0;
    }

    html {
        width: 100%;
        height: 100%;
    }

    body {
        width: 100%;
        height: 100%;
    }

    canvas {
        display: block;
        width: 100%;
        height: 100%;
        background-color: #eeeeee;
        position: absolute;
        left: 0;
        top: 0;
    }
    .dot {
        width: 10px;
        height: 10px;
        position: absolute;
        border-radius: 50%;
        background-color: red;
    }
    .dot1 {
        top: 200px;
        left: 150px;
        /* transform: translate(200px, 150px); */
    }
    .dot2 {
        top: 100px;
        right: 341px;
        /* transform: translate(341px, 100px); */
    }
    .dot3 {
        top: 300px;
        left: 586px;
        /* transform: translate(586px, 300px); */
    }
    #container {
        position: relative;
        width: 100%;
        height: 500px;
        margin: 50px;
        margin: 0 auto;
        background-color: transparent;
    }
    .card {
        border-radius: 5px;
        z-index: 5;
        /* transition: transform 100ms ease-out; */
    }
</style>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <div class="dot dot1"></div>
        <div class="dot dot2"></div>
        <div class="dot dot3"></div>
    </div>

    <script>
        window.onload = () => {
            getPos();

            document.querySelectorAll(".card").forEach((item, idx) => {
                const x = item.getAttribute("x");
                const y = item.getAttribute("y");
                item.addEventListener("mouseenter", function(e){
                    mouseMove({ target: item, pageX: e.pageX, pageY: e.pageY });
                });

                // item.addEventListener("mousemove", function(e){
                //     const { offsetLeft, offsetTop, offsetWidth, offsetHeight } = item.parentElement;
                //     const left = e.pageX - offsetLeft;
                //     const top = e.pageY - offsetTop;
                //     const centerX = (left) - offsetWidth / 2;
                //     const centerY = (top) - offsetHeight / 2;

                //     gsap.to(item, 0.5, {
                //         x: centerX / 1.5,
                //         y: centerY / 1.5,
                //         ease: "power4.out"
                //     })
                //     // item.style.transform = `translate3d(${centerX}px,c ${centerY}px, 0)`;
                //     // mouseMove({ target: item, pageX: e.pageX, pageY: e.pageY });
                //     drawLine();

                //     // console.log("마우스 move~!");
                // });

                item.addEventListener("mouseleave", function(e){
                    let target_idx = Number(item.parentElement.getAttribute("data-idx"));

                    const { offsetLeft, offsetTop, offsetWidth, offsetHeight, offsetParent } = item.parentElement;
                    const left = e.pageX - offsetLeft;
                    const top = e.pageY - offsetTop;
                    const centerX = left - offsetWidth / 2;
                    const centerY = top - offsetHeight / 2;



                    if((idx+1) === target_idx){ // 초기상태로 복귀
                        console.log("◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆ 마우스 leave~! ◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆");
                        // item.style.transform = `translate3d(${x}px, ${y}px, 0)`;
                        // gsap.to(item, 1.2, { x, y, ease: "power4.out" });
                        // drawLine();
                        console.log(`[dot] offsetLeft: ${offsetLeft} | offsetTop: ${offsetTop}`);
                        console.log(offsetParent)
                        console.log(`[card] offsetLeft; ${item.offsetLeft} | offsetTop: ${item.offsetTop}`);
                        console.log(`pageX: ${e.pageX} | pageY: ${e.pageY}\ncenterX: ${centerX} | centerY: ${centerY}`);
                    }
                });
            });
        };

        function mouseMove(obj){
            const data = obj.target.getBoundingClientRect();
            const { offsetLeft, offsetTop, offsetWidth, offsetHeight, offsetParent } = obj.target.parentElement;
            const left = obj.pageX - data.x;
            const top = obj.pageY - data.y;
            const centerX = left - obj.target.offsetWidth / 2;
            const centerY = top - obj.target.offsetHeight / 2;

            console.log("○○○○○○○○○○○○○○○○○○○○○○○○○○○○ 마우스 move~! ○○○○○○○○○○○○○○○○○○○○○○○○○○○○");
            console.log(`[dot] offsetLeft: ${offsetLeft} | offsetTop: ${offsetTop}`);
            console.log(offsetParent)
            console.log(`[card] offsetLeft; ${obj.target.offsetLeft}(${data.x}) | offsetTop: ${obj.target.offsetTop}(${data.y})`)
            console.log(`pageX: ${obj.pageX} | pageY: ${obj.pageY}\ncenterX: ${centerX} | centerY: ${centerY}`);

            // gsap.to(obj.target, 0.5, {
            //     x: centerX,
            //     y: centerY,
            //     ease: "power4.out"
            // })
            obj.target.style.left = `${centerX}px`;
            obj.target.style.top = `${centerY}px`;
            // item.style.transform = `translate3d(${centerX}px,c ${centerY}px, 0)`;
            drawLine();


        }

        function getPos(){
            const dot = document.querySelectorAll(".dot");

            dot.forEach((item, idx) => {
                const data = item.getBoundingClientRect();
                const card = new Card({ data, target: item });
                card.createCard();

                item.setAttribute("data-idx", idx+1);
            });
            drawLine();
        }

        class Card {
            constructor(obj){
                this.dot_width = obj.data.width;
                this.dot_height = obj.data.height;
                this.target = obj.target;
                this.dot_data = this.target.getBoundingClientRect();
                this.corner_pos = [];
                this.centerX = Math.round((this.dot_data.width) / 2 + this.dot_data.x);
                this.centerY = Math.round((this.dot_data.height) / 2 + this.dot_data.y);
                this.cornerX = 0;
                this.cornerY = 0;
                this.canvas = document.getElementById("canvas");
                this.ctx = canvas.getContext("2d");
                this.stage_width = document.body.clientWidth;
                this.stage_height = document.body.clientHeight;
            }

            createCard(){
                const radius = 120;
                const PI2 = Math.PI * 2;
                const points = 30;
                const angle = PI2 / points;
                const width = 150;
                const height = 150;
                const random = Math.floor(Math.random() * points) + 1;
                let centerX, centerY, left, top;

                for(let i = 0; i < points; i++){
                    centerX = radius * Math.cos(angle * i);
                    centerY = radius * Math.sin(angle * i);
                    left = centerX + (this.dot_width / 2) - (width / 2) 
                    top = centerY + (this.dot_height / 2) - (height / 2) 

                    const card = document.createElement("div");
                    card.setAttribute("class", `card card-${i+1}`);
                    card.setAttribute("x", `${left}`);
                    card.setAttribute("y", `${top}`);
                    card.style.width = `${width}px`;
                    card.style.height = `${height}px`;
                    // card.style.lineHeight = `${height}px`;
                    card.style.textAlign = "center";
                    card.style.backgroundColor = "yellow";
                    card.style.position = "absolute";
                    card.style.left = `${left}px`;
                    card.style.top = `${top}px`;
                    // card.style.transform = `translate3d(${left}px, ${top}px, 0)`;
                    card.style.fontSize = `12px`;
                    card.style.fontWeight = "bold";
                    card.style.outline = "1px solid red";
                    card.innerText= `${i + 1} | left: ${Math.round(left)} | top: ${Math.round(top)}`;

                    if(random === (i+1) && this.target.children.length === 0){
                        // console.log(`○○○○○○○○○○○○○○○○○○○○○○○○○○○ random: ${random} ○○○○○○○○○○○○○○○○○○○○○○○○○○○`);
                        this.target.appendChild(card);
                        this.checkCollision(card);
                    }
                }
                this.createCorner();
            }

            checkCollision(card_target){
                const container = document.getElementById("container");
                const cont_data = container.getBoundingClientRect();
                const dots = document.querySelectorAll(".dot");
                const target_data = card_target.getBoundingClientRect();
                const x1 = Math.round(target_data.x);
                const y1 =  Math.round(target_data.y);
                const x2 = x1 + target_data.width;
                const y2 = y1 + target_data.height;
                const stage_x1 = cont_data.x;
                const stage_y1 = cont_data.y;
                const stage_x2 = cont_data.x + cont_data.width;
                const stage_y2 = cont_data.y + cont_data.height;
                let x1_compare, y1_compare, x2_compare, y2_compare;

                dots.forEach((dot) => {
                    if(dot.children[0]){
                        const card = dot.children[0];
                        const card_data = card.getBoundingClientRect();
                        const parent_data = dot.getBoundingClientRect();
                        x1_compare =  Math.round(card_data.x);
                        y1_compare =  Math.round(card_data.y);
                        x2_compare = x1_compare + card_data.width;
                        y2_compare = y1_compare + card_data.height;

                        if(
                            (stage_x1 > x1_compare || stage_x2 < x2_compare) ||
                            (stage_y1 > y1_compare || stage_y2 < y2_compare)
                        ){
                            card.remove();
                            this.createCard({ data: parent_data , target: dot });
                        }

                        if(
                            (x1 < x1_compare && x1_compare < x2) && (y1 < y1_compare && y1_compare < y2) ||
                            (x1 < x1_compare && x1_compare < x2) && (y1 < y2_compare && y1_compare < y2) ||
                            (x1 < x2_compare && x2_compare < x2) && (y1 < y2_compare && y1_compare < y2) ||
                            (x1 < x2_compare && x2_compare < x2) && (y1 < y1_compare && y1_compare < y2)
                        ){
                            card_target.remove();
                            this.createCard({ data: parent_data , target: card_target.parentElem });
                        }
                    }
                });

                const corners = [
                    { width: this.centerX - x1_compare, height: this.centerY - y1_compare, x: x1_compare, y: y1_compare, pos: "left-top" },
                    { width: this.centerX - x1_compare, height: this.centerY - y2_compare, x: x1_compare, y: y2_compare, pos: "left-bottom" },
                    { width: this.centerX - x2_compare, height: this.centerY - y2_compare, x: x2_compare, y: y2_compare, pos: "right-bottom" },
                    { width: this.centerX - x2_compare, height: this.centerY - y1_compare, x: x2_compare, y: y1_compare, pos: "right-top" }
                ]
                this.corner_pos = corners;
            }

            createCorner(){
                const corner = document.createElement("div");

                this.corner_pos.forEach((item, idx) => {
                    const length = Math.round(Math.sqrt((item.width) * (item.width) + (item.height) * (item.height)));
                    this.corner_pos[idx].length = length;
                });
                this.corner_pos.sort(function(a, b) {
                    return a.length < b.length  ? -1 : a.length  > b.length  ? 1 : 0;
                });

                corner.classList.add("corner");
                // corner.style.width = "5px";
                // corner.style.height = "5px";
                corner.style.position = "absolute";
                corner.style.backgroundColor = "pink";

                if(this.corner_pos[0].pos === "left-top"){
                    corner.style.left = "2px";
                    corner.style.top = "2px";
                }
                if(this.corner_pos[0].pos === "right-top"){
                    corner.style.right = "2px";
                    corner.style.top = "2px";
                }
                if(this.corner_pos[0].pos === "left-bottom"){
                    corner.style.left = "2px";
                    corner.style.bottom = "2px";
                }
                if(this.corner_pos[0].pos === "right-bottom"){
                    corner.style.right = "2px";
                    corner.style.bottom = "2px";
                }

                if(this.target.children[0].children.length === 0) this.target.children[0].appendChild(corner);
            }
        }

        window.addEventListener("resize", function(e){
            resize();
            drawLine(); 
        });



        resize();
        function resize(){
            const canvas = document.getElementById("canvas");
            const container = document.getElementById("container");
            const px_ratio = window.pixelRatio = window.devicePixelRatio > 1 ? 2 : 1;
            let stage_width = container.clientWidth;
            let stage_height = container.clientHeight;

            canvas.width = stage_width;
            canvas.height = stage_height;
        }

        function drawLine(){
            const dots = document.querySelectorAll(".dot");
            const corners = document.querySelectorAll(".corner");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const container = document.getElementById("container");
            const stage_width = container.clientWidth;
            const stage_height = container.clientHeight;
            let pos = [];
            let obj;

            dots.forEach((item, idx) => {
                let data = item.getBoundingClientRect();
                let x = (data.width / 2) + data.x;
                let y = (data.height / 2) + data.y;

                obj = { centerX: x, centerY: y };
                pos.push(obj);
            });

            corners.forEach((item, idx) => {
                let data = item.getBoundingClientRect();
                let x = data.x;
                let y = data.y;

                pos[idx]["cornerX"] = x;
                pos[idx]["cornerY"] = y;
            });
            
            // console.log(pos);
            ctx.clearRect(0, 0,stage_width, stage_height);

            pos.forEach((item) => {
                ctx.beginPath();
                ctx.moveTo(item.centerX, item.centerY);
                ctx.lineTo(item.cornerX, item.cornerY);
                ctx.strokeStyle = '#ff0000';
                ctx.stroke();
            });
        }
    </script>
</body>
</html>
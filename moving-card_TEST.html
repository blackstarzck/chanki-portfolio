<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자석효과1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"></script>
</head>
<style>
    * {
        outline: 0;
        margin: 0;
        padding: 0;
    }

    html {
        width: 100%;
        height: 100%;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }

    canvas {
        display: block;
        width: 100%;
        height: 100%;
        background-color: #eeeeee;
        position: absolute;
        left: 0;
        top: 0;
    }
    .dot {
        width: 10px;
        height: 10px;
        position: absolute;
        border-radius: 50%;
        background-color: #ff0000;
    }
    .dot1 {
        top: 30%;
        left: 30%;
    }
    .dot2 {
        top: 35%;
        left: 35%;
    }
    .dot3 {
        top: 40%;
        left: 40%;
    }
    .dot4 {
        top: 45%;
        left: 45%;
    }
    .dot5 {
        top: 50%;
        left: 50%;
    }
    .dot6 {
        top: 55%;
        left: 55%;
    }
    #container {
        position: relative;
        width: 800px;
        height: 800px;
        margin: 50px;
        margin: 0 auto;
        background-color: transparent;
    }
    .card {
        border-radius: 5px;
        background-color: yellow;
        outline: 1px solid #ff0000;
        position: absolute;
        /* transition: 100ms; */
    }
</style>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <div class="dot dot1"></div>
        <div class="dot dot2"></div>
        <div class="dot dot3"></div>
        <div class="dot dot4"></div>
        <div class="dot dot5"></div>
        <div class="dot dot6"></div>
    </div>

    <script>
        window.onload = () => {
            getPos();
            let card = document.querySelectorAll(".card");

            document.querySelectorAll(".card").forEach((card, idx) => {
                document.addEventListener("mousemove", function(e){
                    let target = e.target.classList.contains("card") ?  e.target : "";

                    magnetize(card, e);
                });

                document.addEventListener("mouseleave", function(e){
                    gsap.to(card, 0.6, { y: 0, x: 0, onComplete: function(){
                            rebderState = false;
                        }
                    });
                    card.style.zIndex = 0;
                    drawLine({ stage: "restore" });
                });

                document.addEventListener("scroll", function(e){
                    drawLine({ stage: "scroll" });
                });
            });
        };



        function magnetize(el, e){
            const { offsetLeft, offsetTop } = document.getElementById("container");
            const mX = e.pageX,
                mY = e.pageY;
            const customDist = 120;
            const centerX = el.offsetLeft + (el.offsetWidth / 2) + offsetLeft;
            const centerY = el.offsetTop + (el.offsetHeight / 2) + offsetTop;
            const deltaX = Math.floor((centerX - mX)) * -0.45;
            const deltaY = Math.floor((centerY - mY)) * -0.45;
            const distance = calculateDistance(el, mX, mY);

            if(distance < customDist){
                el.style.zIndex = 5;
                gsap.to(el, 0.5, { y: deltaY, x: deltaX, onUpdate: function(){
                    drawLine({ stage: "init" });
                    }
                });
            }else{
                el.style.zIndex = 0;
                gsap.to(el, 0.6, { y: 0, x: 0, onUpdate: function(){
                    drawLine({ stage: "init" });
                    }
                });
            }
        }

        function calculateDistance(elem, mouseX, mouseY) {
            const { offsetLeft, offsetTop } = document.getElementById("container");

            return Math.floor(Math.sqrt(Math.pow(mouseX - (elem.offsetLeft + offsetLeft + (elem.offsetWidth / 2)), 2) + Math.pow(
                mouseY - (elem.offsetTop + offsetTop + (elem.offsetHeight / 2)), 2)));
        }

        function getPos(){
            const dot = document.querySelectorAll(".dot");

            dot.forEach((item, idx) => {
                item.setAttribute("data-idx", idx+1);

                const data = item.getBoundingClientRect();
                const card = new Card({ data, target: item });
                card.createCard();

            });

            drawLine({ stage: "init" });
        }

        class Card {
            constructor(obj){
                this.dot_width = obj.data.width;
                this.dot_height = obj.data.height;
                this.dot_data = obj.target.getBoundingClientRect();
                this.corner_pos = [];
                this.centerX = Math.round((this.dot_data.width) / 2 + this.dot_data.x);
                this.centerY = Math.round((this.dot_data.height) / 2 + this.dot_data.y);
                this.container = document.getElementById("container");
                this.stage_width = container.clientWidth;
                this.stage_height = container.clientHeight;
            }

            createCard(){
                const radius = 120;
                const PI2 = Math.PI * 2;
                const points = 30;
                const angle = PI2 / points;
                const width = 150;
                const height = 150;
                const random = Math.floor(Math.random() * points) + 1;
                let centerX, centerY, left, top;

                for(let i = 0; i < points; i++){
                    centerX = radius * Math.cos(angle * i) + (this.centerX - this.container.offsetLeft);
                    centerY = radius * Math.sin(angle * i) + (this.centerY - this.container.offsetTop);
                    left = Math.round(centerX + (this.dot_width / 2) - (width / 2));
                    top = Math.round(centerY + (this.dot_height / 2) - (height / 2));

                    const card = document.createElement("div");
                    card.setAttribute("class", `card card-${i+1}`);
                    card.style.left = `${left}px`;
                    card.style.top = `${top}px`;
                    card.style.width = `${width}px`;
                    card.style.height = `${height}px`;
                    card.innerText = `centerX: ${Math.round(centerX)} | centerY: ${Math.round(centerY)}\n\nleft: ${left} | top: ${top}`;

                    if(random === (i+1)){
                        // console.log(`○○○○○○○○○○○○○○○○○○○○○○○○○○○ random: ${random} ○○○○○○○○○○○○○○○○○○○○○○○○○○○`);
                        // console.log(`this.centerX: ${this.centerX} | this.centerY: ${this.centerY}`)
                        
                        this.container.appendChild(card);
                        document.querySelectorAll(".card").forEach((item, idx) => {
                            item.setAttribute("center-target", `dot${idx+1}`);
                        });

                        this.checkCollision(card);
                        this.createCorner(card);
                    }
                }
            }

            checkCollision(card_target){
                // const cont_data = this.container.getBoundingClientRect();
                const { offsetLeft, offsetTop } = document.getElementById("container");
                const window_w = window.outerWidth;
                const window_h = window.outerHeight;
                const cards = document.querySelectorAll(".card");
                const target_data = card_target.getBoundingClientRect();
                const x1 = Math.round(target_data.x);
                const y1 =  Math.round(target_data.y);
                const x2 = x1 + target_data.width;
                const y2 = y1 + target_data.height;
                const stage_x1 = 0;
                const stage_y1 = 0;
                const stage_x2 = window_w;
                const stage_y2 = window_h;
                let x1_compare, y1_compare, x2_compare, y2_compare;

                cards.forEach((card) => {
                    const card_data = card.getBoundingClientRect();
                    const dot = document.querySelector(`.${card.getAttribute("center-target")}`);
                    const dot_data = dot.getBoundingClientRect();
                    x1_compare =  Math.round(card_data.x);
                    y1_compare =  Math.round(card_data.y);
                    x2_compare = x1_compare + card_data.width;
                    y2_compare = y1_compare + card_data.height;

                    if(
                        (stage_x1 > x1_compare || stage_x2 < x2_compare) ||
                        (stage_y1 > y1_compare || stage_y2 < y2_compare)
                    ){
                        card.remove();
                        this.createCard({ data: dot_data , target: dot });
                    }

                    if(
                        (x1 < x1_compare && x1_compare < x2) && (y1 < y1_compare && y1_compare < y2) ||
                        (x1 < x1_compare && x1_compare < x2) && (y1 < y2_compare && y1_compare < y2) ||
                        (x1 < x2_compare && x2_compare < x2) && (y1 < y2_compare && y1_compare < y2) ||
                        (x1 < x2_compare && x2_compare < x2) && (y1 < y1_compare && y1_compare < y2)
                    ){
                        card_target.remove();
                        this.createCard({ 
                            data: dot_data, 
                            target: document.querySelector(`.${card_target.getAttribute("center-target")}`) 
                        });
                    }
                });

                const corners = [
                    { width: this.centerX - x1_compare, height: this.centerY - y1_compare, x: x1_compare, y: y1_compare, pos: "left-top" },
                    { width: this.centerX - x1_compare, height: this.centerY - y2_compare, x: x1_compare, y: y2_compare, pos: "left-bottom" },
                    { width: this.centerX - x2_compare, height: this.centerY - y2_compare, x: x2_compare, y: y2_compare, pos: "right-bottom" },
                    { width: this.centerX - x2_compare, height: this.centerY - y1_compare, x: x2_compare, y: y1_compare, pos: "right-top" }
                ]
                this.corner_pos = corners;
            }

            createCorner(card){
                const corner = document.createElement("div");

                this.corner_pos.forEach((item, idx) => {
                    const length = Math.round(Math.sqrt((item.width) * (item.width) + (item.height) * (item.height)));
                    this.corner_pos[idx].length = length;
                });
                this.corner_pos.sort(function(a, b) {
                    return a.length < b.length  ? -1 : a.length  > b.length  ? 1 : 0;
                });

                corner.classList.add("corner");
                corner.style.position = "absolute";
                corner.style.backgroundColor = "pink";

                if(this.corner_pos[0].pos === "left-top"){
                    corner.style.left = "2px";
                    corner.style.top = "2px";
                }
                if(this.corner_pos[0].pos === "right-top"){
                    corner.style.right = "2px";
                    corner.style.top = "2px";
                }
                if(this.corner_pos[0].pos === "left-bottom"){
                    corner.style.left = "2px";
                    corner.style.bottom = "2px";
                }
                if(this.corner_pos[0].pos === "right-bottom"){
                    corner.style.right = "2px";
                    corner.style.bottom = "2px";
                }

                card.appendChild(corner);
            }
        }

        window.addEventListener("resize", function(e){
            resize();
            drawLine({ stage: "init" });
        });



        resize();
        function resize(obj){
            const canvas = document.getElementById("canvas");
            const container = document.getElementById("container");
            const stage_width = container.clientWidth;
            const stage_height = container.clientHeight;

            canvas.width = stage_width;
            canvas.height = stage_height;

            // console.log(`resize! ${stage_width} | ${stage_height}`)
        }

        let flag_a = true;
        let flag_b = true;
        let org_pos = [];

        function drawLine(obj){
            const dots = document.querySelectorAll(".dot");
            const corners = document.querySelectorAll(".corner");
            const container = document.getElementById("container");
            const stage_width = container.clientWidth;
            const stage_height = container.clientHeight;
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d"); 
            const pos = [];

            dots.forEach((item, idx) => {
                const data = item.getBoundingClientRect();
                // const x = (data.width / 2) + (data.x - offsetLeft);
                // const y = (data.height / 2) + (data.y - offsetTop);
                const x = (item.clientWidth / 2) + item.offsetLeft;
                const y = (item.clientHeight / 2) + item.offsetTop;

                pos.push({ centerX: x, centerY: y });

                if(flag_a === true && (pos.length === dots.length)){
                    org_pos = pos;
                    flag_a = false;
                }
            }); 

            corners.forEach((item, idx) => {
                const data = item.getBoundingClientRect();
                const x = data.x - container.offsetLeft;
                const y = data.y - container.offsetTop + window.pageYOffset;
                // const x = item.offsetLeft;
                // const y = item.offsetTop;

                pos[idx]["cornerX"] = x;
                pos[idx]["cornerY"] = y;
                org_pos[idx]["card"] = item.parentElement;

                if(flag_b === true && pos.length === dots.length){
                    org_pos[idx]["cornerX2"] = Math.round(x);
                    org_pos[idx]["cornerY2"] = Math.round(y);
                    flag_b = false;
                }
            });

            ctx.clearRect(0, 0, stage_width, stage_height);

            if(obj.stage === "restore" || obj.stage === "scroll"){
                org_pos.forEach((item) => {
                    ctx.beginPath();
                    ctx.moveTo(item.centerX, item.centerY);
                    ctx.lineTo(item.cornerX, item.cornerY);
                    ctx.strokeStyle = '#ff0000';
                    ctx.stroke();
                });
            }

            if(obj.stage === "init"){
                pos.forEach((item) => {
                    ctx.beginPath();
                    ctx.moveTo(item.centerX, item.centerY);
                    ctx.lineTo(item.cornerX, item.cornerY);
                    ctx.strokeStyle = '#ff0000';
                    ctx.stroke();
                });
            }
        }
    </script>
</body>
</html>